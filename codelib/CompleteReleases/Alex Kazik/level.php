<?php
	
	/*
	** This work is licensed under the Creative Commons Attribution-ShareAlike 4.0 International License. To view a copy of this license, visit http://creativecommons.org/licenses/by-sa/4.0/deed.en_US.
	*/
		
	$levels = array(
		array(
			'##########',
			'#...######',
			'#.b.....##',
			'#...###.##',
			'##.####.##',
			'##.####.##',
			'#...##.b.#',
			'#.....Pbz#',
			'#...##.zz#',
			'##########',
			array(
				0, 2, 2,
				1, -3, 0,
				1, 0, -1,
				1, -1, 0,
				1, 0, -2,
				1, 1, 0, 
				1, 0, -1,
				1, 2, 0,
				1, 0, 1,
				1, 1, 0,
				1, 0, 3,
				0, 1, 1,
				1, -4, 0,
				1, 0, 1,
				1, -3, 0,
				1, 0, -3,
				1, 1, 0,
				1, 0, -2,
				1, -1, 0,
				1, 0, -3,
				1, 3, 0,
				1, 0, 1,
				1, 2, 0,
				1, 0, -1,
				1, 3, 0,
				1, 0, 3,
				1, -1, 0,
				1, 0, 4,
			),
		),
		array(
			'##########',
			'##.....#.#',
			'##.zbz.#.#',
			'##.bPb...#',
			'##.zbz.#.#',
			'##.....#.#',
			'#####..#.#',
			'########.#',
			'#......#.#',
			'#.zbzb.#.#',
			'#.bzbz...#',
			'#.zbzb.#.#',
			'#......#.#',
			'##########',
			array(
				1, 1, 0,
				1, 0, -3,
				1, 5, 0,
				1, 0, 5,
				1, -2, 0,
				1, 0, 1,
				1, 2, 0,
				1, 0, 1,
				1, -12, 0,
				1, 0, -1,
				1, 2, 0,
				1, 0, -1,
				1, -2, 0,
				1, 0, -6,
				1, 5, 0,
				1, 0, 6,
				1, -2, 0,
				1, 0, 1,
				1, 6, 0,
				1, 0, -1,
				1, -3, 0,
				1, 0, -2,
			),
		),
		array(
			'##########',
			'####..####',
			'###..#.###',
			'##...#..##',
			'#....#..##',
			'#..#.#.bz#',
			'#..#.#..z#',
			'#.##.###z#',
			'#.b.b.b.z#',
			'#..bPb.bz#',
			'#.##.###z#',
			'#..#.#..z#',
			'#..#.#.bz#',
			'#..#.#..##',
			'##.#.#..##',
			'###....###',
			'####..####',
			'##########',
			array(
				0, 1, -1,
				1, 0, -2,
				1, 1, 0,
				1, 0, 1,
				1, 2, 0,
				1, 0, 1,
				1, -3, 0,
				0, -2, 1,
				1, 0, 3,
				1, -1, 0,
				1, 0, -2,
				1, -4, 0,
				1, 0, -1,
				1, 5, 0,
				0, 0, -1,
				1, -5, 0,
				1, 0, -1,
				1, -1, 0,
				1, 0, 1,
				1, -1, 0,
				1, 0, 2,
				1, 1, 0,
				1, 0, 1,
				1, 1, 0,
				1, 0, 1,
				1, 2, 0,
				1, 0, 1,
				1, 8, 0,
				1, 0, -1,
				1, 2, 0,
				1, 0, -1,
				1, 1, 0,
				1, 0, -1,
				1, -5, 0,
				1, 0, 2,
				1, -1, 0,
				1, 0, -3,
				1, 6, 0,
				1, 0, 1,
				1, 1, 0,
				1, 0, -2,
				1, -1, 0,
				1, 0, -1,
				1, -1, 0,
				1, 0, -1,
				1, -1, 0,
				1, 0, -1,
				1, -10, 0,
				1, 0, 1,
				1, -1, 0,
				1, 0, 1,
				1, 4, 0,
				1, 0, -1,
				1, 1, 0,
				1, 0, 2,
			),
		),
		array(
			'##########',
			'###..#####',
			'###.b#####',
			'#z....####',
			'#Pbz....##',
			'#######.##',
			'####....##',
			'####.#####',
			'####.....#',
			'######bb.#',
			'######.###',
			'#####...z#',
			'#####....#',
			'######.#z#',
			'######...#',
			'##########',
			array(
				1, 0, 4,
				1, -2, 0,
				1, 0, -2,
				1, -1, 0,
				1, 0, 2,
				1, -4, 0,
				0, 1, -1,
				1, 0, -1,
				1, 1, 0,
				1, 0, 1,
				1, -1, 0,
				0, -1, 1,
				1, 0, -3,
				1, 2, 0,
				1, 0, -1,
				1, 2, 0,
				1, 0, 1,
				1, 2, 0,
				1, 0, -2,
				1, 3, 0,
				1, 0, 3,
				1, 1, 0,
				1, 0, -6,
				1, 2, 0,
				1, 0, 2,
				1, 2, 0,
				1, 0, 2,
				1, -2, 0,
				1, 0, 1,
				1, -1, 0,
				1, 0, 2,
				1, -3, 0,
				1, 0, -3,
				1, -1, 0,
			),
		),
		array(
			'##########',
			'#........#',
			'#.###.##.#',
			'#.###P##.#',
			'#.###.##.#',
			'#..b.b.#.#',
			'#.b.b.b..#',
			'#....#.###',
			'#.##b#.###',
			'#.##.#.###',
			'#.##.#.###',
			'#.##.#...#',
			'#.##.###.#',
			'#........#',
			'###.....##',
			'######..##',
			'##zzzzzz##',
			'##########',
			array(
				0, 2, 0,
				1, 0, 1,
				1, -5, 0,
				1, 0, 2,
				1, -1, 0,
				1, 0, -3,
				1, 6, 0,
				0, 0, 2,
				1, -4, 0,
				1, 0, 2,
				1, -3, 0,
				1, 0, -1,
				1, -3, 0,
				1, 0, -6,
				1, 1, 0,
				1, 0, 4,
				1, 1, 0,
				1, 0, -3,
				1, 1, 0,
				1, 0, -2,
				0, 1, 1,
				1, 5, 0,
				1, 0, 2,
				1, -5, 0,
				1, 0, -2,
				0, -1, -1,
				1, 13, 0,
				0, -1, 1,
				1, 0, 3,
				1, -3, 0,
				1, 0, -3,
				1, 3, 0,
				0, 1, -1,
				1, 0, 8,
				0, -1, -1,
				1, -4, 0,
				1, 0, -1,
				1, 1, 0,
				1, 0, -1,
				1, 3, 0,
				1, 0, 2,
				0, 1, 1,
				1, -6, 0,
				1, 0, -2,
			),
		),
		array(
			'##########',
			'#..z....z#',
			'#.##.#.#.#',
			'#..b.#.#.#',
			'#.##.#.#.#',
			'#..b.#.#.#',
			'#..#.#.#.#',
			'####.#P#.#',
			'#z.#.#.#.#',
			'#z.#.#.#.#',
			'#z.#.#.#.#',
			'#z.#...#.#',
			'#bb####.b#',
			'#..z#..bz#',
			'#..b..b.z#',
			'#.##bb..z#',
			'#....b..z#',
			'##########',
			array(
				0, -2, 0,
				1, 9, 0,
				1, 0, 1,
				1, -9, 0,
				1, 0, -1,
				0, -1, -1,
				1, 6, 0,
				0, 1, 0,
				1, 1, 0,
				1, 0, -2,
				1, -1, 0,
				1, 0, 2,
				0, -1, 0,
				1, 0, -1,
				1, -1, 0,
				1, 0, -2,
				1, 6, 0,
				0, -1, 1,
				1, 0, 2,
				1, -1, 0,
				1, 0, -2,
				1, 1, 0,
				0, 1, -1,
				1, 0, 8,
				1, -16, 0,
				1, 0, -8,
				0, 1, 1,
				1, 1, 0,
				1, 0, 2,
				1, -1, 0,
				1, 0, -2,
				0, -1, -1,
				1, 9, 0,
				1, 0, 2,
				1, -5, 0,
				1, 0, 1,
				1, -1, 0,
				1, 0, 1,
				1, 1, 0,
				1, 0, 2,
				1, 11, 0,
				1, 0, 1,
				1, -10, 0,
				1, 0, -4,
			),
		),
		array(
			'##########',
			'##########',
			'##########',
			'##########',
			'##########',
			'##########',
			'##########',
			'##########',
			'##########',
			'##########',
			'##########',
			'###P#b#z##',
			'##########',
			'##########',
			'##########',
			'##########',
			'##########',
			'##########',
			array(
				0, -2.5, -6.75,
				1, 5, 0,
				1, 0, 2.333,
				1, -0.666, 0.666,
				1, -3.666, 0,
				1, -0.666, -0.666,
				1, 0, -2.333,
				0, 1, 1,
				1, 3, 0,
				1, 0, 1,
				1, -3, 0,
				1, 0, -1,
				0, -1, 3.666,
				1, 0, 1.666,
				1, 0.666, 0.666,
				1, 3.666, 0,
				1, 0.666, -0.666,
				1, 0, -1.666,
				1, -0.666, -0.666,
				1, -3.666, 0,
				1, -0.666, 0.666,
				0, 1, 0.333,
				1, 3, 0,
				1, 0, 1,
				1, -3, 0,
				1, 0, -1,
				0, -1, 3,
				1, 5, 0,
				1, 0, 2.333,
				1, -0.666, 0.666,
				1, -4.333, 0,
				1, 0, -1,
				1, 4, 0,
				1, 0, -1,
				1, -4, 0,
				1, 0, -1,
				0, 0, 4,
				1, 5, 0,
				1, 0, 2.5,
				1, -1, 0,
				1, 0, -1.5,
				1, -1, 0,
				1, 0, +1,
				1, -1, 0,
				1, 0, -1,
				1, -1, 0,
				1, 0, +1.5,
				1, -1, 0,
				1, 0, -2.5,
			),
		),
	);
	
	$out = '';
	$outdef = 't_levels:'."\n";
	foreach($levels AS $nr => $level){
		$def = array_pop($level);
		$out .= 't_level_'.$nr.'_vec:'."\n";
		$len = 0; $olen = 0;
		for($i=0; $i<count($def); $i+=3){
			$up = $nr == 6 ? 20 : 30;
			$dy = round($def[$i+1]*$up);
			$dx = round($def[$i+2]*$up);
			$scale = 1;
			while(round($dx/$scale) < -128 || round($dx/$scale) > 127 || round($dy/$scale) < -128 || round($dy/$scale) > 127){
				$scale ++;
				if($scale == 3){
					$scale = 4;
				}
			}
			$steps = $scale;
			for($j=0; $j<$scale; $j++){
				$ny = round($dy/$steps);
				$nx = round($dx/$steps);
				if($ny == 0){
					$out .= "\t".'byt '.sprintf('$%02x,       %4d', $def[$i] ? 0x82 : 0x02, $nx)."\n";
					$len+=2;
				}else if($nx == 0){
					$out .= "\t".'byt '.sprintf('$%02x, %4d', $def[$i] ? 0x81 : 0x01, $ny)."\n";
					$len+=2;
				}else{
					$out .= "\t".'byt '.sprintf('$%02x, %4d, %4d', $def[$i] ? 0x83 : 0x03, $ny, $nx)."\n";
					$len+=3;
				}
				$olen += 3;
				$dx -= round($dx/$steps);
				$dy -= round($dy/$steps);
				$steps--;
			}
		}
		$out .= "\t".'byt $00'."\n";
		$len+=1;
		$olen+=1;
		//echo "level $nr = $len <= $olen\n";
		while(count($level) < 18){
			array_unshift($level, '##########');
			array_push($level, '##########');
		}
		array_shift($level);
		array_pop($level);
		foreach($level AS $k => $v){
			$level[$k] = substr($v, 1, 8);
		}
		$out .= 't_level_'.$nr.'_ram:'."\n";
		foreach($level AS $y => $v){
			$out .= "\t".'byt ';
			for($x=0; $x<8; $x++){
				$c = $v[$x];
				if($c == '#'){
					$out .= '(rWL << '.(($x&3)*2).')';
				}else if($c == 'b'){
					$out .= '(rBX << '.(($x&3)*2).')';
				}else if($c == 'z'){
					$out .= '(rTG << '.(($x&3)*2).')';
				}else if($c == 'P'){
					$playerx = $x;
					$playery = $y;
					$out .= '(rFL << '.(($x&3)*2).')';
				}else{
					$out .= '(rFL << '.(($x&3)*2).')';
				}
				if($x < 7){
					if($x == 3){
						$out .= ', ';
					}else{
						$out .= ' | ';
					}
				}
			}
			$out .= "\n";
		}
		$outdef .= ';t_level_'.$nr.':'."\n";
		if($nr == count($levels)-1){
			$outdef .= 't_level_last:'."\n";
		}
		$outdef .= "\t".'adr t_level_'.$nr.'_vec, t_level_'.$nr.'_ram'."\n";
		$outdef .= "\t".'byt '.$playery.', '.$playerx."\n";
		$outdef .= "\t".'byt '.$playery.'*8 + '.$playerx."\n";
	}
	
	echo $out.$outdef;
	
?>